<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ツボマップ｜症状別で該当ツボだけ表示</title>
<style>
  :root { --accent:#0f766e; }
  *{box-sizing:border-box}
  body{margin:0;background:#fafafa;color:#222;font-family:"Noto Sans JP","Yu Gothic",sans-serif}
  header{background:#444;color:#fff;padding:.9rem 1rem;font-weight:600}
  .wrap{max-width:1200px;margin:18px auto;padding:0 14px;display:grid;grid-template-columns:320px 1fr;gap:16px}
  @media(max-width:960px){.wrap{grid-template-columns:1fr}}
  .panel{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
  .panel h2{margin:.2rem 0 .8rem;font-size:1.05rem}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  select{flex:1;padding:.6rem .7rem;border:1px solid #d7d7d7;border-radius:10px;background:#fff;font-size:.95rem}
  button{padding:.55rem .8rem;border-radius:10px;border:1px solid var(--accent);background:var(--accent);color:#fff;cursor:pointer;font-weight:600}
  button.ghost{background:#fff;color:var(--accent)}
  object{width:100%;height:auto;display:block;border-radius:10px;border:1px solid #e6e6e6;background:#fff}

  /* === SVG制御クラス（完全に消す） === */
  ._hide { display:none !important; }
  ._show { display:inline !important; filter:drop-shadow(0 0 2px rgba(15,118,110,.6)); }
  /* 本体（体の輪郭やランドマーク）は常に表示：触らない */
</style>
</head>
<body>
<header>ツボマップ（症状で該当ツボだけ表示）</header>

<div class="wrap">
  <aside class="panel">
    <h2>症状から選ぶ</h2>
    <div class="row">
      <select id="symSelect" aria-label="症状を選択">
        <option value="">— 症状を選択 —</option>
        <option>肩こり</option>
        <option>頭痛</option>
        <option>顎関節痛</option>
        <option>鼻閉・花粉症</option>
        <option>逆流性食道炎</option>
        <option>PMS</option>
        <option>坐骨神経痛</option>
        <option>足関節痛</option>
      </select>
      <button id="apply">表示</button>
      <button class="ghost" id="clear">全表示</button>
    </div>

    <h2 style="margin-top:14px;">選択中のツボ解説</h2>
    <div id="notes"><div style="color:#666;font-size:.9rem">症状を選ぶと表示されます。</div></div>
  </aside>

  <main class="panel">
    <object id="svgObj" type="image/svg+xml" data="tsubo_map_front_medical_web.svg" aria-label="ツボマップ"></object>
  </main>
</div>

<script>
/* ===== 症状→ツボ対応 ===== */
const symptomMap = {
  "肩こり": ["肩井","風池","天柱","肩髃","曲池","合谷"],
  "頭痛": ["百会","印堂","風池","太衝","合谷"],
  "顎関節痛": ["頰車","下関","合谷","太渓"],
  "鼻閉・花粉症": ["迎香","印堂","百会","合谷","上星"],
  "逆流性食道炎": ["内関","中脘","膻中","足三里"],
  "PMS": ["三陰交","太衝","関元","気海"],
  "坐骨神経痛": ["環跳","殷門","委中","承山","承扶","陽陵泉"],
  "足関節痛": ["解谿","崑崙","太谿","丘墟","申脈"]
};

/* ===== ツボ解説（簡潔） ===== */
const tsuboInfo = {
  "肩井": {loc:"肩の中央、僧帽筋の盛り上がる所。", eff:"肩こり・頭重。", how:"指腹で90秒×1〜2回。"},
  "風池": {loc:"後頭骨下、胸鎖乳突筋と僧帽筋の間。", eff:"頭痛・首こり・眼精疲労。", how:"親指で後頭側に軽圧。"},
  "天柱": {loc:"後頭部の生え際、僧帽筋外側。", eff:"後頭部痛・首こり。", how:"前屈して30秒×3。"},
  "肩髃": {loc:"肩関節前外側、水平外転でくぼむ点。", eff:"肩痛・可動域。", how:"円揉みでほぐす。"},
  "曲池": {loc:"肘を曲げたしわ外端。", eff:"肘痛・肩こり補助。", how:"押圧30秒×3。"},
  "合谷": {loc:"手背の第1-2中手骨の合流点。", eff:"頭痛・歯痛・鼻症状。", how:"痛気持ち程度で30〜60秒。"},
  "百会": {loc:"頭頂、両耳尖連結線の正中。", eff:"頭痛・自律神経。", how:"深呼吸と合わせ軽圧。"},
  "印堂": {loc:"眉間中央。", eff:"鼻閉・ストレス。", how:"やさしく点圧。"},
  "太衝": {loc:"足背、第1-2中足骨間。", eff:"頭痛・PMS・イライラ。", how:"30秒×3。"},
  "頰車": {loc:"下顎角の前、咬筋が張る所。", eff:"顎関節痛・食いしばり。", how:"噛筋を緩めるように。"},
  "下関": {loc:"頬骨弓の下、口開閉で動くくぼみ。", eff:"顎関節痛・耳周囲。", how:"口を軽く開けて軽圧。"},
  "太渓": {loc:"内果とアキレス腱の間。", eff:"腰痛・冷え。", how:"温め＋軽圧。"},
  "迎香": {loc:"小鼻外側のくぼみ。", eff:"鼻閉・花粉症。", how:"呼気に合わせ上外へ軽圧。"},
  "上星": {loc:"前髪生え際正中から指1本上。", eff:"鼻閉・頭重。", how:"正中に沿って点圧。"},
  "内関": {loc:"手首中央から肘側へ指3本、腱の間。", eff:"逆流・吐き気。", how:"持続的に軽圧。"},
  "中脘": {loc:"臍と剣状突起の中点。", eff:"胃もたれ・逆流。", how:"食後すぐは避け円揉。"},
  "膻中": {loc:"左右乳頭の中点正中。", eff:"胸のつかえ。", how:"掌で包むように。"},
  "足三里": {loc:"膝下外、脛骨稜から1本外・下へ3本。", eff:"胃腸・全身。", how:"やや強めに。"},
  "三陰交": {loc:"内果上で脛骨内縁の指4本。", eff:"PMS・冷え。", how:"温め＋軽圧。"},
  "関元": {loc:"臍下3寸。", eff:"下腹の冷え・生理痛。", how:"保温＋軽圧。"},
  "気海": {loc:"臍下1.5寸。", eff:"疲労・冷え。", how:"腹式呼吸併用。"},
  "環跳": {loc:"股関節外側、荷重でくぼむ点。", eff:"坐骨神経痛。", how:"殿筋リリース併用。"},
  "殷門": {loc:"大腿後面中央。", eff:"坐骨神経痛。", how:"フォームローラーで優しく。"},
  "委中": {loc:"膝窩中央。", eff:"腰背部痛。", how:"膝軽屈で押圧。"},
  "承山": {loc:"腓腹筋V字の下端。", eff:"ふくらはぎ張り。", how:"つま先立ち→リリース併用。"},
  "承扶": {loc:"坐骨結節の下。", eff:"坐骨神経痛。", how:"短時間で。"},
  "陽陵泉": {loc:"腓骨頭前下のくぼみ。", eff:"膝外側痛。", how:"外側ラインをほぐす。"},
  "解谿": {loc:"足首前面、伸筋腱の間。", eff:"足関節痛。", how:"可動域内で軽圧。"},
  "崑崙": {loc:"外果とアキレス腱の間。", eff:"足関節痛・腰痛。", how:"短時間の指圧。"},
  "丘墟": {loc:"外果前下のくぼみ。", eff:"捻挫後ケア。", how:"軽い円揉。"},
  "申脈": {loc:"外果直下。", eff:"足首安定。", how:"骨沿いにやさしく。"}
};

/* ===== 状態 & 参照 ===== */
const svgObj = document.getElementById('svgObj');
const symSelect = document.getElementById('symSelect');
const notesEl  = document.getElementById('notes');

let svgDoc=null;
let nameToDot = new Map();      // ツボ名 -> circle
let nameToTexts = new Map();    // ツボ名 -> [text,...]
let nameToAux = new Map();      // ツボ名 -> [line,...] 近接の短い補助線

/* ===== SVGロード：ツボ名⇔黒点⇔補助線 を自動対応付け ===== */
svgObj.addEventListener('load', () => {
  svgDoc = svgObj.contentDocument;
  if (!svgDoc) return;

  const circles = Array.from(svgDoc.querySelectorAll('circle'));
  const texts   = Array.from(svgDoc.querySelectorAll('text'));
  const lines   = Array.from(svgDoc.querySelectorAll('line'));

  // textごとに最も近いcircleを代表点として対応付け
  texts.forEach(t => {
    const name = (t.textContent || "").trim().replace(/\s+/g,"");
    if (!name) return;

    const b = t.getBBox();
    const tx = b.x + b.width/2, ty = b.y + b.height/2;

    let best=null, bestD=Infinity;
    circles.forEach(c=>{
      const cx = +c.getAttribute('cx')||0;
      const cy = +c.getAttribute('cy')||0;
      const d2=(cx-tx)*(cx-tx)+(cy-ty)*(cy-ty);
      if(d2<bestD){bestD=d2;best=c;}
    });
    if(best){
      if(!nameToDot.has(name)) nameToDot.set(name,best);
      if(!nameToTexts.has(name)) nameToTexts.set(name,[]);
      nameToTexts.get(name).push(t);
    }
  });

  // 近接の“短い” line を補助線として紐付け（ラベルの引き出し線等）
  // しきい値：距離 <= 40px かつ 長さ <= 60px（適宜調整可）
  const dist = (x1,y1,x2,y2)=>Math.hypot(x1-x2,y1-y2);
  const LEN = (ln)=>Math.hypot((+ln.getAttribute('x1')||0)-(+ln.getAttribute('x2')||0),
                               (+ln.getAttribute('y1')||0)-(+ln.getAttribute('y2')||0));

  nameToDot.forEach((dot, name)=>{
    const cx = +dot.getAttribute('cx')||0;
    const cy = +dot.getAttribute('cy')||0;
    const near = lines.filter(ln=>{
      const x1=+ln.getAttribute('x1')||0, y1=+ln.getAttribute('y1')||0;
      const x2=+ln.getAttribute('x2')||0, y2=+ln.getAttribute('y2')||0;
      const l = LEN(ln);
      const d = Math.min(dist(cx,cy,x1,y1), dist(cx,cy,x2,y2));
      return l<=60 && d<=40; // “短くて近い”線
    });
    if(near.length){
      nameToAux.set(name, near);
    }
  });

  // 初期：全ツボ表示（※「全表示」＝非選択状態）
  showOnly([]);
  renderNotes([]);
});

/* ===== 表示制御：指定ツボ“だけ”残す ===== */
function showOnly(names){
  if(!svgDoc) return;
  const want = new Set(names);

  // まず全ツボ（黒点・テキスト・補助線）を隠す
  nameToDot.forEach(el => el.classList.add('_hide'));
  nameToTexts.forEach(arr => arr.forEach(t => t.classList.add('_hide')));
  nameToAux.forEach(arr => arr.forEach(l => l.classList.add('_hide')));

  if(!names.length){
    // “全表示”状態：すべて見せる
    nameToDot.forEach(el => { el.classList.remove('_hide'); el.classList.remove('_show'); });
    nameToTexts.forEach(arr => arr.forEach(t => t.classList.remove('_hide')));
    nameToAux.forEach(arr => arr.forEach(l => l.classList.remove('_hide')));
    return;
  }

  // 対象のみ表示＋強調
  want.forEach(n=>{
    const dot = nameToDot.get(n);
    if(dot){ dot.classList.remove('_hide'); dot.classList.add('_show'); }
    (nameToTexts.get(n)||[]).forEach(t=> t.classList.remove('_hide'));
    (nameToAux.get(n)||[]).forEach(l=> l.classList.remove('_hide'));
  });
}

/* ===== 解説生成 ===== */
function renderNotes(names){
  if(!names.length){
    notesEl.innerHTML = '<div style="color:#666;font-size:.9rem">症状を選ぶと表示されます。</div>';
    return;
  }
  notesEl.innerHTML = "";
  names.forEach(n=>{
    const info = tsuboInfo[n]||{};
    const wrap = document.createElement('div');
    wrap.style.border = '1px solid #e9f0ef';
    wrap.style.borderRadius = '12px';
    wrap.style.padding = '10px';
    wrap.style.marginBottom = '8px';
    const h = document.createElement('h3'); h.textContent = n; h.style.margin='0 0 4px'; h.style.color='#0f4d4a'; h.style.fontSize='1rem';
    const p1 = document.createElement('p'); p1.innerHTML = `<strong>位置：</strong>${info.loc||"（調整中）"}`; p1.style.margin='4px 0';
    const p2 = document.createElement('p'); p2.innerHTML = `<strong>効能：</strong>${info.eff||"（調整中）"}`; p2.style.margin='4px 0';
    const p3 = document.createElement('p'); p3.innerHTML = `<strong>押し方：</strong>${info.how||"（調整中）"}`; p3.style.margin='4px 0';
    wrap.append(h,p1,p2,p3);
    notesEl.appendChild(wrap);
  });
}

/* ===== イベント ===== */
document.getElementById('apply').onclick = () => {
  const key = symSelect.value;
  const names = key ? (symptomMap[key]||[]) : [];
  showOnly(names);
  renderNotes(names);
};
document.getElementById('clear').onclick = () => {
  symSelect.value = "";
  showOnly([]);     // ＝全ツボ表示
  renderNotes([]);
};
</script>
</body>
</html>
